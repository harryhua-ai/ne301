// @ts-nocheck
/* FileSaver.js
 * A saveAs() FileSaver implementation.
 * 1.3.8
 * 2016-06-16 18:25:19
 *
 * By Eli Grey, http://eligrey.com
 * License: MIT
 *   See https://github.com/eligrey/FileSaver.js/blob/master/LICENSE.md
 */
/* global saveAs,Blob,URL,webkitURL,DataView,ArrayBuffer,Array,define,require,module,exports */
/* eslint-disable strict */
(function (global) {
  'use strict';

  var saveAs = saveAs || (function (view) {
    // 检查是否支持 Blob
    if (typeof view === 'undefined' || typeof navigator !== 'undefined' && /MSIE [1-9]\./.test(navigator.userAgent)) {
      return;
    }
    const
      doc = view.document;
    const save_link = doc.createElementNS('http://www.w3.org/1999/xhtml', 'a');
    const can_use_save_link = 'download' in save_link;
    const click = function (node) {
      const event = new MouseEvent('click');
      doc.dispatchEvent(event);
    };
    const is_safari = /constructor/i.test(view.HTMLElement) || view.safari;
    const is_chrome_ios = /CriOS\/[\d]+/.test(navigator.userAgent);
    const throw_outside = function (ex) {
      (view.setImmediate || view.setTimeout)(() => {
        throw ex;
      }, 0);
    };
    const force_saveable_type = 'application/octet-stream';
    // 任意二进制数据
    const arbitrary_revoke_timeout = 1000 * 40; // 40s
    const revoke = function (file) {
      const revoker = function () {
        if (typeof file === 'string') { // file is an object URL
          get_URL().revokeObjectURL(file);
        } else { // file is a File
          file.remove();
        }
      };
      setTimeout(revoker, arbitrary_revoke_timeout);
    };
    const dispatch = function (filesaver, event_types, event) {
      event_types = [].concat(event_types);
      let i = event_types.length;
      while (i--) {
        const listener = filesaver[`on${event_types[i]}`];
        if (typeof listener === 'function') {
          try {
            listener.call(filesaver, event || filesaver);
          } catch (ex) {
            throw_outside(ex);
          }
        }
      }
    };
    const auto_bom = function (blob) {
      // 为 UTF-8 编码的文本添加 BOM
      if (/^\s*(?:text\/\S*|application\/xml|\S*\/\S*\+xml)\s*;.*charset\s*=\s*utf-8/i.test(blob.type)) {
        return new Blob([String.fromCharCode(0xFEFF), blob], { type: blob.type });
      }
      return blob;
    };
    const FileSaver = function (blob, name, no_auto_bom) {
      if (!no_auto_bom) {
        blob = auto_bom(blob);
      }
      const
        filesaver = this;
      const { type } = blob;
      const force = type === force_saveable_type;
      let object_url;
      filesaver.readyState = filesaver.INIT;
      if (can_use_save_link || (is_chrome_ios && view.File && view.FileReader)) {
        object_url = get_URL().createObjectURL(blob);
        setTimeout(() => {
          const
            save_link = doc.createElementNS('http://www.w3.org/1999/xhtml', 'a');
          const link_download = save_link.download !== 'undefined';
          if (link_download || is_chrome_ios) {
            if (link_download) {
              save_link.href = object_url;
              save_link.download = name;
            } else {
              save_link.href = object_url;
              save_link.target = '_blank';
              save_link.download = name || 'download';
            }
            click(save_link);
          }
          filesaver.readyState = filesaver.DONE;
          dispatch(filesaver, 'writeend');
          revoke(object_url);
        }, arbitrary_revoke_timeout);
      } else if (view.FileReader && view.File && view.FileWriter && view.FileWriter.length > 0) {
        // 使用 FileWriter API
        const
          reader = new FileReader();
        let writer;
        let ready;
        reader.onloadend = function () {
          writer = new FileWriter();
          writer.onwriteend = function (event) {
            filesaver.readyState = filesaver.DONE;
            dispatch(filesaver, 'writeend', event);
          };
          writer.write(new Blob([reader.result], { type }));
        };
        reader.readAsArrayBuffer(blob);
      } else {
        // 回退到下载链接
        setTimeout(() => {
          const
            URL = get_URL();
          const object_url = URL.createObjectURL(blob);
          const dispatch = function () {
            URL.revokeObjectURL(object_url);
            filesaver.readyState = filesaver.DONE;
            dispatch(filesaver, 'writeend');
          };
          if (view.chrome) {
            var
              save_link = doc.createElementNS('http://www.w3.org/1999/xhtml', 'a');
            const event = doc.createEvent('MouseEvents');
            event.initMouseEvent('click', true, true, view, 0, 0, 0, 0, 0, true, false, false, false, 0, null);
            save_link.href = object_url;
            save_link.download = name;
            save_link.dispatchEvent(event);
            setTimeout(dispatch, arbitrary_revoke_timeout);
          } else {
            const is_opera = view.opera && view.opera.version < 12;
            if (is_opera) {
              save_link = doc.createElementNS('http://www.w3.org/1999/xhtml', 'a');
              save_link.href = object_url;
              save_link.download = name;
              click(save_link);
            } else {
              // 回退到 window.open
              view.open(object_url, '_blank');
              setTimeout(dispatch, arbitrary_revoke_timeout);
            }
          }
        }, 0);
      }
    };
    const FS_proto = FileSaver.prototype;
    const saveAs = function (blob, name, no_auto_bom) {
      return new FileSaver(blob, name || blob.name || 'download', no_auto_bom);
    };
    if (typeof navigator !== 'undefined' && navigator.msSaveOrOpenBlob) {
      return function (blob, name, no_auto_bom) {
        name = name || blob.name || 'download';
        if (!no_auto_bom) {
          blob = auto_bom(blob);
        }
        return navigator.msSaveOrOpenBlob(blob, name);
      };
    }
    FS_proto.abort = function () {
      const
        filesaver = this;
      let event;
      filesaver.readyState = filesaver.DONE;
      dispatch(filesaver, 'abort');
    };
    FS_proto.readyState = FS_proto.INIT = 0;
    FS_proto.WRITING = 1;
    FS_proto.DONE = 2;
    FS_proto.error = FS_proto.onwritestart = FS_proto.onprogress = FS_proto.onwrite = FS_proto.onabort = FS_proto.onerror = FS_proto.onwriteend = null;
    return view.saveAs || function (blob, name, no_auto_bom) {
      return new FileSaver(blob, name || blob.name || 'download', no_auto_bom);
    };
  }(typeof self !== 'undefined' && self || typeof window !== 'undefined' && window || this.content));
  if (typeof module !== 'undefined' && module.exports) {
    module.exports.saveAs = saveAs;
  } else if (typeof define !== 'undefined' && define !== null && define.amd !== undefined) {
    define('FileSaver.js', () => saveAs);
  }
}.call(this)); 